<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Keep all the previous CSS and meta tags] -->
</head>
<body>
    <!-- [Keep all the previous HTML structure] -->

    <script>
        // Telegram Web App initialization
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Configuration - SET THESE VALUES
        const BOT_USERNAME = "YourBotUsername"; // Change to your actual bot username
        const ADMIN_USERNAME = "NexWon"; // Your Telegram username for order notifications
        
        // User data with initial values
        let userData = {
            balance: 0,
            points: 0,
            totalRefers: 0,
            activeRefers: 0,
            referralLink: "",
            orders: []
        };

        // [Keep all previous DOM element selectors]

        // Persistent storage using localStorage
        const storage = {
            getUsers: function() {
                const usersJson = localStorage.getItem('starExchangeUsers');
                return usersJson ? JSON.parse(usersJson) : {};
            },
            
            saveUsers: function(users) {
                localStorage.setItem('starExchangeUsers', JSON.stringify(users));
            },
            
            getOrders: function() {
                const ordersJson = localStorage.getItem('starExchangeOrders');
                return ordersJson ? JSON.parse(ordersJson) : {};
            },
            
            saveOrders: function(orders) {
                localStorage.setItem('starExchangeOrders', JSON.stringify(orders));
            }
        };

        // Backend simulation with persistent storage
        const backend = {
            users: storage.getUsers(),
            orders: storage.getOrders(),
            
            initUser: function(userId) {
                if (!this.users[userId]) {
                    this.users[userId] = {
                        balance: 0,
                        points: 0,
                        totalRefers: 0,
                        activeRefers: 0,
                        referralLink: `https://t.me/${BOT_USERNAME}?start=ref${userId}`,
                        orders: []
                    };
                    this.saveData();
                }
                return this.users[userId];
            },
            
            getUserData: function(userId) {
                return this.initUser(userId);
            },
            
            placeOrder: function(userId, amount, username) {
                const user = this.initUser(userId);
                
                if (amount > user.balance) {
                    return { success: false, message: "Insufficient balance" };
                }
                
                const orderId = Date.now().toString();
                const newOrder = {
                    id: orderId,
                    amount: amount,
                    status: 'pending',
                    date: new Date().toISOString().split('T')[0],
                    userId: userId,
                    username: username
                };
                
                user.orders.unshift(orderId);
                user.balance -= amount;
                
                // Store the order
                this.orders[orderId] = newOrder;
                
                this.saveData();
                
                // In a real app, you would send a message to @NexWon here
                console.log(`Order notification: User @${username} placed order for ${amount} stars`);
                
                return { success: true, order: newOrder };
            },
            
            addReferral: function(userId) {
                const user = this.initUser(userId);
                user.totalRefers += 1;
                user.activeRefers += 1;
                user.points += 1;
                
                // Check if points reached 15
                if (user.points >= 15) {
                    const starsEarned = 30;
                    user.balance += starsEarned;
                    user.points -= 15;
                    this.saveData();
                    return { starsAdded: starsEarned };
                }
                
                this.saveData();
                return { starsAdded: 0 };
            },
            
            saveData: function() {
                storage.saveUsers(this.users);
                storage.saveOrders(this.orders);
            },
            
            getUserOrders: function(userId) {
                const user = this.initUser(userId);
                return user.orders.map(orderId => this.orders[orderId]).filter(o => o);
            }
        };

        // Function to fetch user data
        async function fetchUserData() {
            try {
                // Get user ID from Telegram WebApp
                const userId = tg.initDataUnsafe.user?.id;
                if (!userId) throw new Error("User not authenticated");
                
                // Get data from our backend
                const data = backend.getUserData(userId);
                const orders = backend.getUserOrders(userId);
                
                // Update userData
                userData = {
                    balance: data.balance,
                    points: data.points,
                    totalRefers: data.totalRefers,
                    activeRefers: data.activeRefers,
                    referralLink: data.referralLink,
                    orders: orders
                };

                updateUI();
                
            } catch (error) {
                console.error("Error fetching user data:", error);
                showNotification('Failed to load data. Please try again.', 'error');
            }
        }

        // Function to place an order
        async function placeOrder(amount, username) {
            try {
                const userId = tg.initDataUnsafe.user?.id;
                if (!userId) throw new Error("User not authenticated");
                
                // Remove @ if present and validate
                username = username.replace('@', '').trim();
                if (!username) throw new Error("Please enter your Telegram username");
                
                // Send to backend
                const result = backend.placeOrder(userId, amount, username);
                
                if (result.success) {
                    // Refresh data
                    await fetchUserData();
                    showNotification('Order placed successfully!', 'success');
                    
                    // Clear form
                    redeemAmountEl.value = '';
                    usernameEl.value = '';
                    
                    // In a real implementation, you would notify the admin here
                    // Example: tg.sendData(JSON.stringify({
                    //     type: 'new_order',
                    //     orderId: result.order.id,
                    //     amount: amount,
                    //     username: username
                    // }));
                } else {
                    throw new Error(result.message || 'Order failed');
                }
                
            } catch (error) {
                console.error("Error placing order:", error);
                showNotification(error.message || 'Failed to place order', 'error');
            }
        }

        // Update UI with current user data
        function updateUI() {
            balanceEl.textContent = `${userData.balance} ★`;
            currentPointsEl.textContent = userData.points;
            progressFillEl.style.width = `${(userData.points / 15) * 100}%`;
            totalRefersEl.textContent = userData.totalRefers;
            activeRefersEl.textContent = userData.activeRefers;
            referralLinkEl.value = userData.referralLink;
            
            // Update order history
            if (userData.orders.length > 0) {
                orderListEl.innerHTML = '';
                userData.orders.forEach(order => {
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    
                    let statusClass = '';
                    if (order.status === 'completed') statusClass = 'status-completed';
                    else if (order.status === 'pending') statusClass = 'status-pending';
                    else if (order.status === 'failed') statusClass = 'status-failed';
                    
                    orderItem.innerHTML = `
                        <div class="order-details">
                            <div>Order #${order.id.slice(-6)}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${order.date}</div>
                        </div>
                        <div class="order-amount">${order.amount} ★</div>
                        <div class="order-status ${statusClass}">${order.status}</div>
                    `;
                    
                    orderListEl.appendChild(orderItem);
                });
            } else {
                orderListEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No orders yet</p>';
            }
        }

        // [Keep all other helper functions and event listeners]

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize with some demo data for new users
            const userId = tg.initDataUnsafe.user?.id;
            if (userId && !backend.users[userId]) {
                const newUser = backend.initUser(userId);
                
                // Add some initial balance for demo purposes
                newUser.balance = 15;
                newUser.points = 5;
                newUser.totalRefers = 5;
                newUser.activeRefers = 5;
                backend.saveData();
            }
            
            fetchUserData();
            
            // Set up periodic refresh (every 2 minutes)
            setInterval(fetchUserData, 120000);
            
            // Check for referral parameter
            if (window.location.search.includes('ref=')) {
                const refUserId = window.location.search.split('ref=')[1].split('&')[0];
                if (refUserId && refUserId !== userId) {
                    const result = backend.addReferral(refUserId);
                    if (result.starsAdded > 0) {
                        console.log(`User ${refUserId} earned ${result.starsAdded} stars from referral`);
                    }
                    // Refresh to show updated balance if this is the referrer
                    if (userId === refUserId) {
                        fetchUserData();
                    }
                }
            }
        });
    </script>
</body>
</html>
